'use strict';

exports.__esModule = true;

var _biBaseItem = require('../common/bi-base-item');

var _biBaseItem2 = _interopRequireDefault(_biBaseItem);

var _location = require('../../app-data/location');

var _location2 = _interopRequireDefault(_location);

var _performance = require('../../performance/performance');

var _performance2 = _interopRequireDefault(_performance);

function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

function _possibleConstructorReturn(self, call) {
    if (!self) {
        throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    }
    return call && (typeof call === "object" || typeof call === "function") ? call : self;
}

function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
        throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);
    }
    subClass.prototype = Object.create(superClass && superClass.prototype, {
        constructor: {
            value: subClass,
            enumerable: false,
            writable: true,
            configurable: true
        }
    });
    if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;
}

var RESOURCES_TYPES = {
    xmlhttprequest: {
        count: 'countXhr',
        unsupported: 'unsprtXhr',
        duration: 'timeXhr',
        total: 'sizeXhr',
        longest: 'longXhr',
        http2: 'h2Xhr'
    },
    script: {
        count: 'countJs',
        unsupported: 'unsprtJs',
        duration: 'timeJs',
        total: 'sizeJs',
        cached: 'cachedJs',
        http2: 'h2Js'
    },
    link: {
        // css
        count: 'countCss',
        unsupported: 'unsprtCss',
        duration: 'timeCss',
        total: 'sizeCss',
        cached: 'cachedCss',
        http2: 'h2Css'
    },
    img: {
        count: 'countImg',
        unsupported: 'unsprtImg',
        duration: 'timeImg',
        total: 'sizeImg',
        cached: 'cachedImages',
        http2: 'h2Images'
    }
};

var CUSTOM_VALIDATORS = {
    link: function link(resource) {
        return (/(.\.css$|.\.css?.)/g.test(resource.name));
    }
};

var durationOf = function durationOf(item) {
    return item.responseEnd - item.startTime;
};

function filterResourcesByType(resources, type) {
    var validator = CUSTOM_VALIDATORS[type];
    return resources.filter(function(r) {
        return type === r.initiatorType && (validator ? validator(r) : true);
    });
}

function calculateTotalSizeOfResource(resources) {
    return resources.reduce(function(totalSize, resource) {
        return totalSize + resource.transferSize;
    }, 0);
}

function calculateResourceLoadLongestDuration(resources) {
    if (resources.length === 0) {
        return 0;
    }
    var longest = resources.reduce(function(acc, cur) {
        return durationOf(cur) >= durationOf(acc) ? cur : acc;
    });
    return durationOf(longest);
}

function calculateResourceLoadDuration(resources) {
    if (resources.length === 0) {
        return 0;
    }
    var loadStartStop = {
        startTime: Infinity,
        responseEnd: 0
    };
    resources.forEach(function(r) {
        if (loadStartStop.startTime > r.startTime) {
            loadStartStop.startTime = r.startTime;
        }
        if (loadStartStop.responseEnd < r.responseEnd) {
            loadStartStop.responseEnd = r.responseEnd;
        }
    });
    return loadStartStop.responseEnd - loadStartStop.startTime;
}

function calculatePercentageOfUnsupportedResources(resources) {
    var totalCount = resources.length;
    if (totalCount === 0) {
        return 0;
    }
    var unsupportedCount = resources.filter(isResourceUnsupported).length;
    return Math.round(unsupportedCount / totalCount * 100);
}

function calculateCachedResourcesPercentage(resources) {
    if (resources.length === 0) {
        return 0;
    }
    var cached = resources.filter(function(r) {
        return r.transferSize === 0;
    });
    return Math.round(cached.length / resources.length * 100);
}

function calculatePercentageOfHttp2(resources) {
    if (resources.length === 0) {
        return 0;
    }
    var supported = false;
    var res = Math.round(resources.filter(function(r) {
        supported = supported || 'nextHopProtocol' in r;
        return r.nextHopProtocol === 'h2';
    }).length / resources.length * 100);
    return supported ? res : NaN;
}

function isResourceRelevant(resource) {
    return !resource.name.match(/http(s)?:\/\/frog.wix.com\//);
}

function isResourceUnsupported(resource) {
    return isCORS(resource.name) && resource.transferSize === 0 && resource.requestStart === 0;
}

function isCORS(resourceName) {
    var host = _location2.default.getHost();
    return host && resourceName.indexOf(host) === -1;
}

function normalizeValues(analysis) {
    return Object.keys(analysis).reduce(function(result, key) {
        var n = parseInt(analysis[key]);
        if (!isNaN(n) && typeof n === 'number') {
            result[key] = n;
        }
        return result;
    }, {});
}

function countAllResourcesByType(resources) {
    var supportedResources = resources.filter(function(r) {
        return !isResourceUnsupported(r);
    });
    return Object.keys(RESOURCES_TYPES).reduce(function(result, currentType) {
        var allSameTypeResources = filterResourcesByType(resources, currentType);
        var supportedSameTypeResources = filterResourcesByType(supportedResources, currentType);
        var type = RESOURCES_TYPES[currentType];
        result[type.count] = supportedSameTypeResources.length;
        result[type.duration] = calculateResourceLoadDuration(supportedSameTypeResources);
        result[type.total] = calculateTotalSizeOfResource(supportedSameTypeResources);
        result[type.unsupported] = calculatePercentageOfUnsupportedResources(allSameTypeResources);
        result[type.http2] = calculatePercentageOfHttp2(allSameTypeResources);
        if (type.longest) {
            result[type.longest] = calculateResourceLoadLongestDuration(supportedSameTypeResources);
        }
        if (type.cached) {
            result[type.cached] = calculateCachedResourcesPercentage(supportedSameTypeResources);
        }
        return result;
    }, {});
}

function extractResourceMetrics(resource) {
    return {
        url: resource.name,
        downloadDuration: resource.responseEnd - resource.startTime,
        bytesTransferred: resource.transferSize,
        isHTTP2: resource.nextHopProtocol === 'h2'
    };
}

function getResourcesBreakdown(resources) {
    var resourcesPartition = resources.reduce(function(result, r) {
        if (isResourceUnsupported(r)) {
            result.unsupported.push(r);
        } else {
            result.supported.push(r);
        }
        return result;
    }, {
        supported: [],
        unsupported: []
    });
    return Object.keys(RESOURCES_TYPES).reduce(function(result, currentType) {
        result[currentType] = {};
        result[currentType].supported = filterResourcesByType(resourcesPartition.supported, currentType).map(function(r) {
            return extractResourceMetrics(r);
        });
        result[currentType].unsupported = filterResourcesByType(resourcesPartition.unsupported, currentType).map(function(r) {
            return extractResourceMetrics(r);
        });
        return result;
    }, {});
}

var ResourceDataItem = function(_BiBaseDataItem) {
    _inherits(ResourceDataItem, _BiBaseDataItem);

    function ResourceDataItem(sessionId) {
        _classCallCheck(this, ResourceDataItem);

        return _possibleConstructorReturn(this, _BiBaseDataItem.call(this, 18, sessionId));
    }

    ResourceDataItem.prototype.performNetworkAnalysis = function performNetworkAnalysis(resources) {
        if (resources.length === 0) {
            return null;
        }
        var t0 = _performance2.default.now();
        var resourcesToHandle = resources.filter(isResourceRelevant);
        var analysis = countAllResourcesByType(resourcesToHandle);
        analysis.overhead = _performance2.default.now() - t0;
        var result = normalizeValues(analysis);
        if (console.debug && _location2.default.isFedopsDev()) {
            var resourcesBreakdown = getResourcesBreakdown(resourcesToHandle);
            console.debug('[fedops network analysis] [bytes analysis]\n' + JSON.stringify(result, null, 4));
            console.debug('[fedops network analysis] [resources breakdown]\n', resourcesBreakdown);
        }
        return result;
    };

    return ResourceDataItem;
}(_biBaseItem2.default);

exports.default = ResourceDataItem;